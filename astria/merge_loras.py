import os.path
import traceback

from safetensors import safe_open
from safetensors.torch import save_file
import tqdm
# woman
lora_ids = "1575550 1575499 1575335 1575297 1575248 1575069 1575067 1574980 1574971 1574968 1574951 1574946 1574939 1574920 1574877 1574870 1574790 1574748 1574717 1574706 1574693 1574679 1574662 1574627 1574605 1574595 1574577 1574499 1574442 1574394 1574358 1574332 1574278 1574235 1574161 1574159 1574005 1573970 1573917 1573899 1573888 1573886 1573841 1573796 1573685 1573445 1573406 1573326 1573225 1573203 1573194 1573178 1573171 1573137 1573084 1573069 1573062 1573014 1572979 1572833 1572780 1572779 1572771 1572673 1572626 1572521 1572517 1572468 1572435 1572383 1572335 1572298 1572276 1572267 1572207 1572105 1572054 1572011 1571958 1571953 1571903 1571898 1571864 1571776 1571769 1571746 1571684 1571683 1571680 1571479 1571362 1571356 1571346 1571318 1571233 1571201 1571194 1571009 1570743 1570728 1570683 1570563 1570356 1570194 1570022 1569963 1569904 1569902 1569876 1569845 1569822 1569769 1569635 1569568 1569545 1569522 1569505 1569494 1569485 1569427 1569376 1569306 1569271 1569214 1569191 1569114 1569109 1569101 1568985 1568730 1568472 1568327 1568324 1568274 1568222 1568141 1568077 1568072 1568065 1568062 1568031 1568025 1567972 1567949 1567864 1567829 1567805 1567725 1567720 1567617 1567614 1567600 1567402 1567370 1567312 1567309 1567289 1567244 1567194 1567174 1567107 1567075 1566996 1566951 1566753 1566032 1565995 1565985 1565911 1565776 1565737 1565733 1565652 1565594 1565589 1565483 1565427 1565312 1565250 1565237 1565232 1565122 1565080 1565029 1565007 1564994 1564976 1564944 1564826 1564744 1564620 1564273 1564256 1564235 1564210 1564183 1564149 1564137 1564049 1564045 1563954 1563884 1563878 1563702 1563323 1563309 1563269 1563086 1562979 1562947 1562813 1562766 1562756 1562729 1562691 1562659 1562598 1562585 1562580 1562576 1562556 1562342 1562306 1562039 1561970 1561962 1561954 1561856 1561774 1561728 1561654 1561618 1561570 1561503 1561442 1561347 1561334 1561265 1561242 1561230 1561212 1561004 1560842 1560833 1560735 1560697 1560667 1560663 1560616 1560559 1560551 1560388 1560382 1560328 1560173 1560103 1560081 1560069 1560061 1560033 1559990 1559916 1559882 1559764 1559580 1559247 1559036 1558931 1558851 1558849 1558713 1558710 1558704 1558703 1558687 1558577 1558556 1558443 1558429 1558408 1558396 1558319 1558259 1558228 1558219 1558214 1558210 1558134 1558057 1558045 1558037 1558023 1558013 1557924 1557875 1557763 1557674 1557595 1557590 1557567 1557527 1557487 1557456 1557408 1557402 1557388 1557377 1557309 1557274 1557161 1557149 1556803 1556795 1556777 1556698 1556565 1556523 1556421 1556293 1556241 1556224 1556167 1556083 1556007 1556005 1555956 1555926 1555912 1555775 1555747 1555746 1555741 1555735 1555734 1555713 1555645 1555610 1555561 1555559 1555555 1555540 1555515 1555492 1555458 1555445 1555412 1555307 1555236 1555231 1555218 1555206 1555101 1555091 1555030 1555024 1555002 1554985 1554904 1554902 1554877 1554839 1554831 1554817 1554761 1554679 1554671 1554670 1554602 1554582 1554528 1554497 1554494 1554469 1554400 1554328 1554092 1554014 1553832 1553693 1553672 1553583 1553300 1553270 1553212 1553197 1553183 1553138 1553135 1552925 1552883 1552876 1552844 1552802 1552702 1552696 1552660 1552659 1552657 1552637 1552627 1552623 1552566 1552499 1552473 1552403 1552384 1552382 1552370 1552283 1552277 1552164 1552159 1552149 1552140 1552133 1552083 1552050 1552043 1552042 1552034 1551990 1551918 1551888 1551881 1551875 1551852 1551732 1551728 1551695 1551682 1551620 1551607 1551594 1551519 1551490 1551466 1551194 1551038 1550760 1550687 1550649 1550639 1550613 1550593 1550570 1550552 1550277 1550224 1550179 1550077 1549998 1549844 1549812 1549798 1549769 1549754 1549684 1549631 1549621 1549582 1549533 1549521 1549520 1549519 1549493 1549466 1549033 1548851 1548850 1548838 1548770 1548646 1548637 1548532 1548495 1548096 1548038 1548032 1548012 1547726 1547468 1547460 1547360 1547184 1547086 1547074 1546747 1546426 1546298 1546252 1546213 1546205 1546101 1546060 1546002 1545982 1545949 1545756 1545591 1545525 1545402 1545247 1545231 1545200 1545157 1545090 1545084 1545031 1544717 1544575 1544389 1544381 1544367 1544340 1544161 1544098 1544079 1544068 1544055 1544035 1544016 1544011 1544008 1543975 1543942 1543887 1543792 1543782 1543752 1543588 1543523 1543289 1543285 1543240 1543199 1543194 1542885 1542705 1542690 1542255 1541602 1541588 1541490 1541371 1540754 1540286 1540254 1540222 1540206 1539526 1539460 1539253 1539251 1539237 1539071 1538834 1538285 1538278 1537869 1537862 1537765 1537350 1536798 1536743 1536607 1536596 1536541 1536232 1536072 1536019 1535946 1535055 1533312 1532296 1531040 1530509 1530375 1530016 1529487 1529289 1529268 1529121 1528798 1528220 1528128 1527789 1527473 1527332 1527078 1526871 1526639 1526451 1526446 1526429 1526422 1526264 1526100 1526065 1526053 1525962 1525370 1525088 1524932 1524184 1524102 1523680 1523444 1523399 1523257 1523249 1523198 1522935 1522627 1522622 1522613 1522519 1522325 1522021 1522004 1521815 1521747 1521600 1521591 1521589 1521337 1520553 1520547 1520494 1520346 1520219 1519820 1519486 1519319 1518317 1518098 1517598 1515665 1513385".split()
lora_ids = "1577300 1577292 1577254 1577180 1577000 1576998 1576989 1576983 1576981 1576980 1576977 1576972 1576911 1576757".split()
n_loras = len(lora_ids)
tensors = {}

mismatched_keys = 0
for id in tqdm.tqdm(lora_ids):
    fn = f"/data/models/{id}.safetensors"
    # if not os.path.exists(fn):
    #     os.system("aws s3 cp s3://sdbooth2-production/models/{id}.safetensors {fn}")
    with safe_open(fn, framework="pt", device=0) as f:
        if tensors == {}:
            for k in f.keys():
                tensors[k] = f.get_tensor(k) / n_loras
                print("initializing ", k)
        else:
            print("merging ", fn)
            if len(f.keys()) != len(tensors.keys()):
                print(f"mismatched keys: {len(f.keys())} != {len(tensors.keys())}")
                mismatched_keys += 1
                continue
            try:
                for k in f.keys():
                    tensors[k] += f.get_tensor(k) / n_loras
            except:
                traceback.print_exc()
                mismatched_keys += 1

for k in tensors.keys():
    tensors[k] = tensors[k] * n_loras / (n_loras - mismatched_keys)


save_file(tensors, '/data/cache/merged_woman.safetensors')
