import peft
import torch
import safetensors.torch


def determine_adapter_target_modules(args, unet, transformer):
    if unet is not None:
        return ["to_k", "to_q", "to_v", "to_out.0"]
    elif transformer is not None:
        target_modules = ["to_k", "to_q", "to_v", "to_out.0"]

        if args.model_family.lower() == "flux" and args.flux_lora_target == "all":
            # target_modules = mmdit layers here
            target_modules = [
                "to_k",
                "to_q",
                "to_v",
                "add_k_proj",
                "add_q_proj",
                "add_v_proj",
                "to_out.0",
                "to_add_out",
            ]
        elif args.flux_lora_target == "context":
            # i think these are the text input layers.
            target_modules = [
                "add_k_proj",
                "add_q_proj",
                "add_v_proj",
                "to_add_out",
            ]
        elif args.flux_lora_target == "context+ffs":
            # i think these are the text input layers.
            target_modules = [
                "add_k_proj",
                "add_q_proj",
                "add_v_proj",
                "to_add_out",
                "ff_context.net.0.proj",
                "ff_context.net.2",
            ]
        elif args.flux_lora_target == "all+ffs":
            target_modules = [
                "to_k",
                "to_q",
                "to_v",
                "add_k_proj",
                "add_q_proj",
                "add_v_proj",
                "to_out.0",
                "to_add_out",
                "ff.net.0.proj",
                "ff.net.2",
                "ff_context.net.0.proj",
                "ff_context.net.2",
                "proj_mlp",
                "proj_out",
            ]
        elif args.flux_lora_target == "ai-toolkit":
            # from ostris' ai-toolkit, possibly required to continue finetuning one.
            target_modules = [
                "to_q",
                "to_k",
                "to_v",
                "add_q_proj",
                "add_k_proj",
                "add_v_proj",
                "to_out.0",
                "to_add_out",
                "ff.net.0.proj",
                "ff.net.2",
                "ff_context.net.0.proj",
                "ff_context.net.2",
                "norm.linear",
                "norm1.linear",
                "norm1_context.linear",
                "proj_mlp",
                "proj_out",
            ]
        elif args.flux_lora_target == "tiny":
            # From TheLastBen
            # https://www.reddit.com/r/StableDiffusion/comments/1f523bd/good_flux_loras_can_be_less_than_45mb_128_dim/
            target_modules = [
                "single_transformer_blocks.7.proj_out",
                "single_transformer_blocks.20.proj_out",
            ]
        elif args.flux_lora_target == "nano":
            # From TheLastBen
            # https://www.reddit.com/r/StableDiffusion/comments/1f523bd/good_flux_loras_can_be_less_than_45mb_128_dim/
            target_modules = [
                "single_transformer_blocks.7.proj_out",
            ]
        elif args.flux_lora_target == 'portrait':
            target_modules = [
                "proj_out",
                "single_transformer_blocks.0.attn.to_k",
                "single_transformer_blocks.0.attn.to_q",
                "single_transformer_blocks.0.attn.to_v",
                "single_transformer_blocks.0.proj_mlp",
                "single_transformer_blocks.0.proj_out",
                "single_transformer_blocks.1.attn.to_k",
                "single_transformer_blocks.1.attn.to_q",
                "single_transformer_blocks.1.attn.to_v",
                "single_transformer_blocks.1.proj_mlp",
                "single_transformer_blocks.1.proj_out",
                "single_transformer_blocks.10.attn.to_k",
                "single_transformer_blocks.10.attn.to_q",
                "single_transformer_blocks.10.attn.to_v",
                "single_transformer_blocks.10.proj_mlp",
                "single_transformer_blocks.10.proj_out",
                "single_transformer_blocks.11.attn.to_k",
                "single_transformer_blocks.11.attn.to_q",
                "single_transformer_blocks.11.attn.to_v",
                "single_transformer_blocks.11.proj_mlp",
                "single_transformer_blocks.11.proj_out",
                "single_transformer_blocks.12.attn.to_k",
                "single_transformer_blocks.12.attn.to_q",
                "single_transformer_blocks.12.attn.to_v",
                "single_transformer_blocks.12.proj_mlp",
                "single_transformer_blocks.12.proj_out",
                "single_transformer_blocks.13.attn.to_k",
                "single_transformer_blocks.13.attn.to_q",
                "single_transformer_blocks.13.attn.to_v",
                "single_transformer_blocks.13.proj_mlp",
                "single_transformer_blocks.13.proj_out",
                "single_transformer_blocks.14.attn.to_k",
                "single_transformer_blocks.14.attn.to_q",
                "single_transformer_blocks.14.attn.to_v",
                "single_transformer_blocks.14.proj_mlp",
                "single_transformer_blocks.14.proj_out",
                "single_transformer_blocks.15.attn.to_k",
                "single_transformer_blocks.15.attn.to_q",
                "single_transformer_blocks.15.attn.to_v",
                "single_transformer_blocks.15.proj_mlp",
                "single_transformer_blocks.15.proj_out",
                "single_transformer_blocks.16.attn.to_k",
                "single_transformer_blocks.16.attn.to_q",
                "single_transformer_blocks.16.attn.to_v",
                "single_transformer_blocks.16.proj_mlp",
                "single_transformer_blocks.16.proj_out",
                "single_transformer_blocks.17.attn.to_k",
                "single_transformer_blocks.17.attn.to_q",
                "single_transformer_blocks.17.attn.to_v",
                "single_transformer_blocks.17.proj_mlp",
                "single_transformer_blocks.17.proj_out",
                "single_transformer_blocks.18.attn.to_k",
                "single_transformer_blocks.18.attn.to_q",
                "single_transformer_blocks.18.attn.to_v",
                "single_transformer_blocks.18.proj_mlp",
                "single_transformer_blocks.18.proj_out",
                "single_transformer_blocks.19.attn.to_k",
                "single_transformer_blocks.19.attn.to_q",
                "single_transformer_blocks.19.attn.to_v",
                "single_transformer_blocks.19.proj_mlp",
                "single_transformer_blocks.19.proj_out",
                "single_transformer_blocks.2.attn.to_k",
                "single_transformer_blocks.2.attn.to_q",
                "single_transformer_blocks.2.attn.to_v",
                "single_transformer_blocks.2.proj_mlp",
                "single_transformer_blocks.2.proj_out",
                "single_transformer_blocks.20.attn.to_k",
                "single_transformer_blocks.20.attn.to_q",
                "single_transformer_blocks.20.attn.to_v",
                "single_transformer_blocks.20.proj_mlp",
                "single_transformer_blocks.20.proj_out",
                "single_transformer_blocks.21.attn.to_k",
                "single_transformer_blocks.21.attn.to_q",
                "single_transformer_blocks.21.attn.to_v",
                "single_transformer_blocks.21.proj_mlp",
                "single_transformer_blocks.21.proj_out",
                "single_transformer_blocks.22.attn.to_k",
                "single_transformer_blocks.22.attn.to_q",
                "single_transformer_blocks.22.attn.to_v",
                "single_transformer_blocks.22.proj_mlp",
                "single_transformer_blocks.22.proj_out",
                "single_transformer_blocks.23.attn.to_k",
                "single_transformer_blocks.23.attn.to_q",
                "single_transformer_blocks.23.attn.to_v",
                "single_transformer_blocks.23.proj_mlp",
                "single_transformer_blocks.23.proj_out",
                "single_transformer_blocks.24.attn.to_k",
                "single_transformer_blocks.24.attn.to_q",
                "single_transformer_blocks.24.attn.to_v",
                "single_transformer_blocks.24.proj_mlp",
                "single_transformer_blocks.24.proj_out",
                "single_transformer_blocks.25.attn.to_k",
                "single_transformer_blocks.25.attn.to_q",
                "single_transformer_blocks.25.attn.to_v",
                "single_transformer_blocks.25.proj_mlp",
                "single_transformer_blocks.25.proj_out",
                "single_transformer_blocks.26.attn.to_k",
                "single_transformer_blocks.26.attn.to_q",
                "single_transformer_blocks.26.attn.to_v",
                "single_transformer_blocks.26.proj_mlp",
                "single_transformer_blocks.26.proj_out",
                "single_transformer_blocks.27.attn.to_k",
                "single_transformer_blocks.27.attn.to_q",
                "single_transformer_blocks.27.attn.to_v",
                "single_transformer_blocks.27.proj_mlp",
                "single_transformer_blocks.27.proj_out",
                "single_transformer_blocks.28.attn.to_k",
                "single_transformer_blocks.28.attn.to_q",
                "single_transformer_blocks.28.attn.to_v",
                "single_transformer_blocks.28.proj_mlp",
                "single_transformer_blocks.28.proj_out",
                "single_transformer_blocks.29.attn.to_k",
                "single_transformer_blocks.29.attn.to_q",
                "single_transformer_blocks.29.attn.to_v",
                "single_transformer_blocks.29.proj_mlp",
                "single_transformer_blocks.29.proj_out",
                "single_transformer_blocks.3.attn.to_k",
                "single_transformer_blocks.3.attn.to_q",
                "single_transformer_blocks.3.attn.to_v",
                "single_transformer_blocks.3.proj_mlp",
                "single_transformer_blocks.3.proj_out",
                "single_transformer_blocks.30.attn.to_k",
                "single_transformer_blocks.30.attn.to_q",
                "single_transformer_blocks.30.attn.to_v",
                "single_transformer_blocks.30.proj_mlp",
                "single_transformer_blocks.30.proj_out",
                "single_transformer_blocks.31.attn.to_k",
                "single_transformer_blocks.31.attn.to_q",
                "single_transformer_blocks.31.attn.to_v",
                "single_transformer_blocks.31.proj_mlp",
                "single_transformer_blocks.31.proj_out",
                "single_transformer_blocks.32.attn.to_k",
                "single_transformer_blocks.32.attn.to_q",
                "single_transformer_blocks.32.attn.to_v",
                "single_transformer_blocks.32.proj_mlp",
                "single_transformer_blocks.32.proj_out",
                "single_transformer_blocks.33.attn.to_k",
                "single_transformer_blocks.33.attn.to_q",
                "single_transformer_blocks.33.attn.to_v",
                "single_transformer_blocks.33.proj_mlp",
                "single_transformer_blocks.33.proj_out",
                "single_transformer_blocks.34.attn.to_k",
                "single_transformer_blocks.34.attn.to_q",
                "single_transformer_blocks.34.attn.to_v",
                "single_transformer_blocks.34.proj_mlp",
                "single_transformer_blocks.34.proj_out",
                "single_transformer_blocks.35.attn.to_k",
                "single_transformer_blocks.35.attn.to_q",
                "single_transformer_blocks.35.attn.to_v",
                "single_transformer_blocks.35.proj_mlp",
                "single_transformer_blocks.35.proj_out",
                "single_transformer_blocks.36.attn.to_k",
                "single_transformer_blocks.36.attn.to_q",
                "single_transformer_blocks.36.attn.to_v",
                "single_transformer_blocks.36.proj_mlp",
                "single_transformer_blocks.36.proj_out",
                "single_transformer_blocks.37.attn.to_k",
                "single_transformer_blocks.37.attn.to_q",
                "single_transformer_blocks.37.attn.to_v",
                "single_transformer_blocks.37.proj_mlp",
                "single_transformer_blocks.37.proj_out",
                "single_transformer_blocks.4.attn.to_k",
                "single_transformer_blocks.4.attn.to_q",
                "single_transformer_blocks.4.attn.to_v",
                "single_transformer_blocks.4.proj_mlp",
                "single_transformer_blocks.4.proj_out",
                "single_transformer_blocks.5.attn.to_k",
                "single_transformer_blocks.5.attn.to_q",
                "single_transformer_blocks.5.attn.to_v",
                "single_transformer_blocks.5.proj_mlp",
                "single_transformer_blocks.5.proj_out",
                "single_transformer_blocks.6.attn.to_k",
                "single_transformer_blocks.6.attn.to_q",
                "single_transformer_blocks.6.attn.to_v",
                "single_transformer_blocks.6.proj_mlp",
                "single_transformer_blocks.6.proj_out",
                "single_transformer_blocks.7.attn.to_k",
                "single_transformer_blocks.7.attn.to_q",
                "single_transformer_blocks.7.attn.to_v",
                "single_transformer_blocks.7.proj_mlp",
                "single_transformer_blocks.7.proj_out",
                "single_transformer_blocks.8.attn.to_k",
                "single_transformer_blocks.8.attn.to_q",
                "single_transformer_blocks.8.attn.to_v",
                "single_transformer_blocks.8.proj_mlp",
                "single_transformer_blocks.8.proj_out",
                "single_transformer_blocks.9.attn.to_k",
                "single_transformer_blocks.9.attn.to_q",
                "single_transformer_blocks.9.attn.to_v",
                "single_transformer_blocks.9.proj_mlp",
                "single_transformer_blocks.9.proj_out",
                "transformer_blocks.0.attn.add_k_proj",
                "transformer_blocks.0.attn.add_q_proj",
                "transformer_blocks.0.attn.add_v_proj",
                "transformer_blocks.0.attn.to_add_out",
                "transformer_blocks.0.attn.to_k",
                "transformer_blocks.0.attn.to_out.0",
                "transformer_blocks.0.attn.to_q",
                "transformer_blocks.0.attn.to_v",
                "transformer_blocks.0.ff.net.0.proj",
                "transformer_blocks.0.ff.net.2",
                "transformer_blocks.0.ff_context.net.0.proj",
                "transformer_blocks.0.ff_context.net.2",
                "transformer_blocks.1.attn.add_k_proj",
                "transformer_blocks.1.attn.add_q_proj",
                "transformer_blocks.1.attn.add_v_proj",
                "transformer_blocks.1.attn.to_add_out",
                "transformer_blocks.1.attn.to_k",
                "transformer_blocks.1.attn.to_out.0",
                "transformer_blocks.1.attn.to_q",
                "transformer_blocks.1.attn.to_v",
                "transformer_blocks.1.ff.net.0.proj",
                "transformer_blocks.1.ff.net.2",
                "transformer_blocks.1.ff_context.net.0.proj",
                "transformer_blocks.1.ff_context.net.2",
                "transformer_blocks.10.attn.add_k_proj",
                "transformer_blocks.10.attn.add_q_proj",
                "transformer_blocks.10.attn.add_v_proj",
                "transformer_blocks.10.attn.to_add_out",
                "transformer_blocks.10.attn.to_k",
                "transformer_blocks.10.attn.to_out.0",
                "transformer_blocks.10.attn.to_q",
                "transformer_blocks.10.attn.to_v",
                "transformer_blocks.10.ff.net.0.proj",
                "transformer_blocks.10.ff.net.2",
                "transformer_blocks.10.ff_context.net.0.proj",
                "transformer_blocks.10.ff_context.net.2",
                "transformer_blocks.11.attn.add_k_proj",
                "transformer_blocks.11.attn.add_q_proj",
                "transformer_blocks.11.attn.add_v_proj",
                "transformer_blocks.11.attn.to_add_out",
                "transformer_blocks.11.attn.to_k",
                "transformer_blocks.11.attn.to_out.0",
                "transformer_blocks.11.attn.to_q",
                "transformer_blocks.11.attn.to_v",
                "transformer_blocks.11.ff.net.0.proj",
                "transformer_blocks.11.ff.net.2",
                "transformer_blocks.11.ff_context.net.0.proj",
                "transformer_blocks.11.ff_context.net.2",
                "transformer_blocks.12.attn.add_k_proj",
                "transformer_blocks.12.attn.add_q_proj",
                "transformer_blocks.12.attn.add_v_proj",
                "transformer_blocks.12.attn.to_add_out",
                "transformer_blocks.12.attn.to_k",
                "transformer_blocks.12.attn.to_out.0",
                "transformer_blocks.12.attn.to_q",
                "transformer_blocks.12.attn.to_v",
                "transformer_blocks.12.ff.net.0.proj",
                "transformer_blocks.12.ff.net.2",
                "transformer_blocks.12.ff_context.net.0.proj",
                "transformer_blocks.12.ff_context.net.2",
                "transformer_blocks.13.attn.add_k_proj",
                "transformer_blocks.13.attn.add_q_proj",
                "transformer_blocks.13.attn.add_v_proj",
                "transformer_blocks.13.attn.to_add_out",
                "transformer_blocks.13.attn.to_k",
                "transformer_blocks.13.attn.to_out.0",
                "transformer_blocks.13.attn.to_q",
                "transformer_blocks.13.attn.to_v",
                "transformer_blocks.13.ff.net.0.proj",
                "transformer_blocks.13.ff.net.2",
                "transformer_blocks.13.ff_context.net.0.proj",
                "transformer_blocks.13.ff_context.net.2",
                "transformer_blocks.14.attn.add_k_proj",
                "transformer_blocks.14.attn.add_q_proj",
                "transformer_blocks.14.attn.add_v_proj",
                "transformer_blocks.14.attn.to_add_out",
                "transformer_blocks.14.attn.to_k",
                "transformer_blocks.14.attn.to_out.0",
                "transformer_blocks.14.attn.to_q",
                "transformer_blocks.14.attn.to_v",
                "transformer_blocks.14.ff.net.0.proj",
                "transformer_blocks.14.ff.net.2",
                "transformer_blocks.14.ff_context.net.0.proj",
                "transformer_blocks.14.ff_context.net.2",
                "transformer_blocks.15.attn.add_k_proj",
                "transformer_blocks.15.attn.add_q_proj",
                "transformer_blocks.15.attn.add_v_proj",
                "transformer_blocks.15.attn.to_add_out",
                "transformer_blocks.15.attn.to_k",
                "transformer_blocks.15.attn.to_out.0",
                "transformer_blocks.15.attn.to_q",
                "transformer_blocks.15.attn.to_v",
                "transformer_blocks.15.ff.net.0.proj",
                "transformer_blocks.15.ff.net.2",
                "transformer_blocks.15.ff_context.net.0.proj",
                "transformer_blocks.15.ff_context.net.2",
                "transformer_blocks.16.attn.add_k_proj",
                "transformer_blocks.16.attn.add_q_proj",
                "transformer_blocks.16.attn.add_v_proj",
                "transformer_blocks.16.attn.to_add_out",
                "transformer_blocks.16.attn.to_k",
                "transformer_blocks.16.attn.to_out.0",
                "transformer_blocks.16.attn.to_q",
                "transformer_blocks.16.attn.to_v",
                "transformer_blocks.16.ff.net.0.proj",
                "transformer_blocks.16.ff.net.2",
                "transformer_blocks.16.ff_context.net.0.proj",
                "transformer_blocks.16.ff_context.net.2",
                "transformer_blocks.17.attn.add_k_proj",
                "transformer_blocks.17.attn.add_q_proj",
                "transformer_blocks.17.attn.add_v_proj",
                "transformer_blocks.17.attn.to_add_out",
                "transformer_blocks.17.attn.to_k",
                "transformer_blocks.17.attn.to_out.0",
                "transformer_blocks.17.attn.to_q",
                "transformer_blocks.17.attn.to_v",
                "transformer_blocks.17.ff.net.0.proj",
                "transformer_blocks.17.ff.net.2",
                "transformer_blocks.17.ff_context.net.0.proj",
                "transformer_blocks.17.ff_context.net.2",
                "transformer_blocks.18.attn.add_k_proj",
                "transformer_blocks.18.attn.add_q_proj",
                "transformer_blocks.18.attn.add_v_proj",
                "transformer_blocks.18.attn.to_add_out",
                "transformer_blocks.18.attn.to_k",
                "transformer_blocks.18.attn.to_out.0",
                "transformer_blocks.18.attn.to_q",
                "transformer_blocks.18.attn.to_v",
                "transformer_blocks.18.ff.net.0.proj",
                "transformer_blocks.18.ff.net.2",
                "transformer_blocks.18.ff_context.net.0.proj",
                "transformer_blocks.18.ff_context.net.2",
                "transformer_blocks.2.attn.add_k_proj",
                "transformer_blocks.2.attn.add_q_proj",
                "transformer_blocks.2.attn.add_v_proj",
                "transformer_blocks.2.attn.to_add_out",
                "transformer_blocks.2.attn.to_k",
                "transformer_blocks.2.attn.to_out.0",
                "transformer_blocks.2.attn.to_q",
                "transformer_blocks.2.attn.to_v",
                "transformer_blocks.2.ff.net.0.proj",
                "transformer_blocks.2.ff.net.2",
                "transformer_blocks.2.ff_context.net.0.proj",
                "transformer_blocks.2.ff_context.net.2",
                "transformer_blocks.3.attn.add_k_proj",
                "transformer_blocks.3.attn.add_q_proj",
                "transformer_blocks.3.attn.add_v_proj",
                "transformer_blocks.3.attn.to_add_out",
                "transformer_blocks.3.attn.to_k",
                "transformer_blocks.3.attn.to_out.0",
                "transformer_blocks.3.attn.to_q",
                "transformer_blocks.3.attn.to_v",
                "transformer_blocks.3.ff.net.0.proj",
                "transformer_blocks.3.ff.net.2",
                "transformer_blocks.3.ff_context.net.0.proj",
                "transformer_blocks.3.ff_context.net.2",
                "transformer_blocks.4.attn.add_k_proj",
                "transformer_blocks.4.attn.add_q_proj",
                "transformer_blocks.4.attn.add_v_proj",
                "transformer_blocks.4.attn.to_add_out",
                "transformer_blocks.4.attn.to_k",
                "transformer_blocks.4.attn.to_out.0",
                "transformer_blocks.4.attn.to_q",
                "transformer_blocks.4.attn.to_v",
                "transformer_blocks.4.ff.net.0.proj",
                "transformer_blocks.4.ff.net.2",
                "transformer_blocks.4.ff_context.net.0.proj",
                "transformer_blocks.4.ff_context.net.2",
                "transformer_blocks.5.attn.add_k_proj",
                "transformer_blocks.5.attn.add_q_proj",
                "transformer_blocks.5.attn.add_v_proj",
                "transformer_blocks.5.attn.to_add_out",
                "transformer_blocks.5.attn.to_k",
                "transformer_blocks.5.attn.to_out.0",
                "transformer_blocks.5.attn.to_q",
                "transformer_blocks.5.attn.to_v",
                "transformer_blocks.5.ff.net.0.proj",
                "transformer_blocks.5.ff.net.2",
                "transformer_blocks.5.ff_context.net.0.proj",
                "transformer_blocks.5.ff_context.net.2",
                "transformer_blocks.6.attn.add_k_proj",
                "transformer_blocks.6.attn.add_q_proj",
                "transformer_blocks.6.attn.add_v_proj",
                "transformer_blocks.6.attn.to_add_out",
                "transformer_blocks.6.attn.to_k",
                "transformer_blocks.6.attn.to_out.0",
                "transformer_blocks.6.attn.to_q",
                "transformer_blocks.6.attn.to_v",
                "transformer_blocks.6.ff.net.0.proj",
                "transformer_blocks.6.ff.net.2",
                "transformer_blocks.6.ff_context.net.0.proj",
                "transformer_blocks.6.ff_context.net.2",
                "transformer_blocks.7.attn.add_k_proj",
                "transformer_blocks.7.attn.add_q_proj",
                "transformer_blocks.7.attn.add_v_proj",
                "transformer_blocks.7.attn.to_add_out",
                "transformer_blocks.7.attn.to_k",
                "transformer_blocks.7.attn.to_out.0",
                "transformer_blocks.7.attn.to_q",
                "transformer_blocks.7.attn.to_v",
                "transformer_blocks.7.ff.net.0.proj",
                "transformer_blocks.7.ff.net.2",
                "transformer_blocks.7.ff_context.net.0.proj",
                "transformer_blocks.7.ff_context.net.2",
                "transformer_blocks.8.attn.add_k_proj",
                "transformer_blocks.8.attn.add_q_proj",
                "transformer_blocks.8.attn.add_v_proj",
                "transformer_blocks.8.attn.to_add_out",
                "transformer_blocks.8.attn.to_k",
                "transformer_blocks.8.attn.to_out.0",
                "transformer_blocks.8.attn.to_q",
                "transformer_blocks.8.attn.to_v",
                "transformer_blocks.8.ff.net.0.proj",
                "transformer_blocks.8.ff.net.2",
                "transformer_blocks.8.ff_context.net.0.proj",
                "transformer_blocks.8.ff_context.net.2",
                "transformer_blocks.9.attn.add_k_proj",
                "transformer_blocks.9.attn.add_q_proj",
                "transformer_blocks.9.attn.add_v_proj",
                "transformer_blocks.9.attn.to_add_out",
                "transformer_blocks.9.attn.to_k",
                "transformer_blocks.9.attn.to_out.0",
                "transformer_blocks.9.attn.to_q",
                "transformer_blocks.9.attn.to_v",
                "transformer_blocks.9.ff.net.0.proj",
                "transformer_blocks.9.ff.net.2",
                "transformer_blocks.9.ff_context.net.0.proj",
                "transformer_blocks.9.ff_context.net.2",
            ]
        elif args.flux_lora_target == '84':
            target_modules = [
                "single_transformer_blocks.0.attn.to_k",
                "single_transformer_blocks.0.attn.to_q",
                "single_transformer_blocks.0.attn.to_v",
                "single_transformer_blocks.1.attn.to_k",
                "single_transformer_blocks.1.attn.to_q",
                "single_transformer_blocks.1.attn.to_v",
                "single_transformer_blocks.10.attn.to_k",
                "single_transformer_blocks.10.attn.to_q",
                "single_transformer_blocks.10.attn.to_v",
                "single_transformer_blocks.11.attn.to_k",
                "single_transformer_blocks.11.attn.to_q",
                "single_transformer_blocks.11.attn.to_v",
                "single_transformer_blocks.12.attn.to_k",
                "single_transformer_blocks.12.attn.to_q",
                "single_transformer_blocks.12.attn.to_v",
                "single_transformer_blocks.13.attn.to_k",
                "single_transformer_blocks.13.attn.to_q",
                "single_transformer_blocks.13.attn.to_v",
                "single_transformer_blocks.14.attn.to_k",
                "single_transformer_blocks.14.attn.to_q",
                "single_transformer_blocks.14.attn.to_v",
                "single_transformer_blocks.15.attn.to_k",
                "single_transformer_blocks.15.attn.to_q",
                "single_transformer_blocks.15.attn.to_v",
                "single_transformer_blocks.16.attn.to_k",
                "single_transformer_blocks.16.attn.to_q",
                "single_transformer_blocks.16.attn.to_v",
                "single_transformer_blocks.17.attn.to_k",
                "single_transformer_blocks.17.attn.to_q",
                "single_transformer_blocks.17.attn.to_v",
                "single_transformer_blocks.18.attn.to_k",
                "single_transformer_blocks.18.attn.to_q",
                "single_transformer_blocks.18.attn.to_v",
                "single_transformer_blocks.19.attn.to_k",
                "single_transformer_blocks.19.attn.to_q",
                "single_transformer_blocks.19.attn.to_v",
                "single_transformer_blocks.2.attn.to_k",
                "single_transformer_blocks.2.attn.to_q",
                "single_transformer_blocks.2.attn.to_v",
                "single_transformer_blocks.20.attn.to_k",
                "single_transformer_blocks.20.attn.to_q",
                "single_transformer_blocks.20.attn.to_v",
                "single_transformer_blocks.21.attn.to_k",
                "single_transformer_blocks.21.attn.to_q",
                "single_transformer_blocks.21.attn.to_v",
                "single_transformer_blocks.22.attn.to_k",
                "single_transformer_blocks.22.attn.to_q",
                "single_transformer_blocks.22.attn.to_v",
                "single_transformer_blocks.23.attn.to_k",
                "single_transformer_blocks.23.attn.to_q",
                "single_transformer_blocks.23.attn.to_v",
                "single_transformer_blocks.24.attn.to_k",
                "single_transformer_blocks.24.attn.to_q",
                "single_transformer_blocks.24.attn.to_v",
                "single_transformer_blocks.25.attn.to_k",
                "single_transformer_blocks.25.attn.to_q",
                "single_transformer_blocks.25.attn.to_v",
                "single_transformer_blocks.26.attn.to_k",
                "single_transformer_blocks.26.attn.to_q",
                "single_transformer_blocks.26.attn.to_v",
                "single_transformer_blocks.27.attn.to_k",
                "single_transformer_blocks.27.attn.to_q",
                "single_transformer_blocks.27.attn.to_v",
                "single_transformer_blocks.28.attn.to_k",
                "single_transformer_blocks.28.attn.to_q",
                "single_transformer_blocks.28.attn.to_v",
                "single_transformer_blocks.29.attn.to_k",
                "single_transformer_blocks.29.attn.to_q",
                "single_transformer_blocks.29.attn.to_v",
                "single_transformer_blocks.3.attn.to_k",
                "single_transformer_blocks.3.attn.to_q",
                "single_transformer_blocks.3.attn.to_v",
                "single_transformer_blocks.30.attn.to_k",
                "single_transformer_blocks.30.attn.to_q",
                "single_transformer_blocks.30.attn.to_v",
                "single_transformer_blocks.31.attn.to_k",
                "single_transformer_blocks.31.attn.to_q",
                "single_transformer_blocks.31.attn.to_v",
                "single_transformer_blocks.32.attn.to_k",
                "single_transformer_blocks.32.attn.to_q",
                "single_transformer_blocks.32.attn.to_v",
                "single_transformer_blocks.33.attn.to_k",
                "single_transformer_blocks.33.attn.to_q",
                "single_transformer_blocks.33.attn.to_v",
                "single_transformer_blocks.34.attn.to_k",
                "single_transformer_blocks.34.attn.to_q",
                "single_transformer_blocks.34.attn.to_v",
                "single_transformer_blocks.35.attn.to_k",
                "single_transformer_blocks.35.attn.to_q",
                "single_transformer_blocks.35.attn.to_v",
                "single_transformer_blocks.36.attn.to_k",
                "single_transformer_blocks.36.attn.to_q",
                "single_transformer_blocks.36.attn.to_v",
                "single_transformer_blocks.37.attn.to_k",
                "single_transformer_blocks.37.attn.to_q",
                "single_transformer_blocks.37.attn.to_v",
                "single_transformer_blocks.4.attn.to_k",
                "single_transformer_blocks.4.attn.to_q",
                "single_transformer_blocks.4.attn.to_v",
                "single_transformer_blocks.5.attn.to_k",
                "single_transformer_blocks.5.attn.to_q",
                "single_transformer_blocks.5.attn.to_v",
                "single_transformer_blocks.6.attn.to_k",
                "single_transformer_blocks.6.attn.to_q",
                "single_transformer_blocks.6.attn.to_v",
                "single_transformer_blocks.7.attn.to_k",
                "single_transformer_blocks.7.attn.to_q",
                "single_transformer_blocks.7.attn.to_v",
                "single_transformer_blocks.8.attn.to_k",
                "single_transformer_blocks.8.attn.to_q",
                "single_transformer_blocks.8.attn.to_v",
                "single_transformer_blocks.9.attn.to_k",
                "single_transformer_blocks.9.attn.to_q",
                "single_transformer_blocks.9.attn.to_v",
                "transformer_blocks.0.attn.add_k_proj",
                "transformer_blocks.0.attn.add_q_proj",
                "transformer_blocks.0.attn.add_v_proj",
                "transformer_blocks.0.attn.to_add_out",
                "transformer_blocks.0.attn.to_k",
                "transformer_blocks.0.attn.to_out.0",
                "transformer_blocks.0.attn.to_q",
                "transformer_blocks.0.attn.to_v",
                "transformer_blocks.0.ff.net.0.proj",
                "transformer_blocks.0.ff.net.2",
                "transformer_blocks.0.ff_context.net.0.proj",
                "transformer_blocks.0.ff_context.net.2",
                "transformer_blocks.1.attn.add_k_proj",
                "transformer_blocks.1.attn.add_q_proj",
                "transformer_blocks.1.attn.add_v_proj",
                "transformer_blocks.1.attn.to_add_out",
                "transformer_blocks.1.attn.to_k",
                "transformer_blocks.1.attn.to_out.0",
                "transformer_blocks.1.attn.to_q",
                "transformer_blocks.1.attn.to_v",
                "transformer_blocks.1.ff.net.0.proj",
                "transformer_blocks.1.ff.net.2",
                "transformer_blocks.1.ff_context.net.0.proj",
                "transformer_blocks.1.ff_context.net.2",
                "transformer_blocks.10.attn.add_k_proj",
                "transformer_blocks.10.attn.add_q_proj",
                "transformer_blocks.10.attn.add_v_proj",
                "transformer_blocks.10.attn.to_add_out",
                "transformer_blocks.10.attn.to_k",
                "transformer_blocks.10.attn.to_out.0",
                "transformer_blocks.10.attn.to_q",
                "transformer_blocks.10.attn.to_v",
                "transformer_blocks.10.ff.net.0.proj",
                "transformer_blocks.10.ff.net.2",
                "transformer_blocks.10.ff_context.net.0.proj",
                "transformer_blocks.10.ff_context.net.2",
                "transformer_blocks.11.attn.add_k_proj",
                "transformer_blocks.11.attn.add_q_proj",
                "transformer_blocks.11.attn.add_v_proj",
                "transformer_blocks.11.attn.to_add_out",
                "transformer_blocks.11.attn.to_k",
                "transformer_blocks.11.attn.to_out.0",
                "transformer_blocks.11.attn.to_q",
                "transformer_blocks.11.attn.to_v",
                "transformer_blocks.11.ff.net.0.proj",
                "transformer_blocks.11.ff.net.2",
                "transformer_blocks.11.ff_context.net.0.proj",
                "transformer_blocks.11.ff_context.net.2",
                "transformer_blocks.12.attn.add_k_proj",
                "transformer_blocks.12.attn.add_q_proj",
                "transformer_blocks.12.attn.add_v_proj",
                "transformer_blocks.12.attn.to_add_out",
                "transformer_blocks.12.attn.to_k",
                "transformer_blocks.12.attn.to_out.0",
                "transformer_blocks.12.attn.to_q",
                "transformer_blocks.12.attn.to_v",
                "transformer_blocks.12.ff.net.0.proj",
                "transformer_blocks.12.ff.net.2",
                "transformer_blocks.12.ff_context.net.0.proj",
                "transformer_blocks.12.ff_context.net.2",
                "transformer_blocks.13.attn.add_k_proj",
                "transformer_blocks.13.attn.add_q_proj",
                "transformer_blocks.13.attn.add_v_proj",
                "transformer_blocks.13.attn.to_add_out",
                "transformer_blocks.13.attn.to_k",
                "transformer_blocks.13.attn.to_out.0",
                "transformer_blocks.13.attn.to_q",
                "transformer_blocks.13.attn.to_v",
                "transformer_blocks.13.ff.net.0.proj",
                "transformer_blocks.13.ff.net.2",
                "transformer_blocks.13.ff_context.net.0.proj",
                "transformer_blocks.13.ff_context.net.2",
                "transformer_blocks.14.attn.add_k_proj",
                "transformer_blocks.14.attn.add_q_proj",
                "transformer_blocks.14.attn.add_v_proj",
                "transformer_blocks.14.attn.to_add_out",
                "transformer_blocks.14.attn.to_k",
                "transformer_blocks.14.attn.to_out.0",
                "transformer_blocks.14.attn.to_q",
                "transformer_blocks.14.attn.to_v",
                "transformer_blocks.14.ff.net.0.proj",
                "transformer_blocks.14.ff.net.2",
                "transformer_blocks.14.ff_context.net.0.proj",
                "transformer_blocks.14.ff_context.net.2",
                "transformer_blocks.15.attn.add_k_proj",
                "transformer_blocks.15.attn.add_q_proj",
                "transformer_blocks.15.attn.add_v_proj",
                "transformer_blocks.15.attn.to_add_out",
                "transformer_blocks.15.attn.to_k",
                "transformer_blocks.15.attn.to_out.0",
                "transformer_blocks.15.attn.to_q",
                "transformer_blocks.15.attn.to_v",
                "transformer_blocks.15.ff.net.0.proj",
                "transformer_blocks.15.ff.net.2",
                "transformer_blocks.15.ff_context.net.0.proj",
                "transformer_blocks.15.ff_context.net.2",
                "transformer_blocks.16.attn.add_k_proj",
                "transformer_blocks.16.attn.add_q_proj",
                "transformer_blocks.16.attn.add_v_proj",
                "transformer_blocks.16.attn.to_add_out",
                "transformer_blocks.16.attn.to_k",
                "transformer_blocks.16.attn.to_out.0",
                "transformer_blocks.16.attn.to_q",
                "transformer_blocks.16.attn.to_v",
                "transformer_blocks.16.ff.net.0.proj",
                "transformer_blocks.16.ff.net.2",
                "transformer_blocks.16.ff_context.net.0.proj",
                "transformer_blocks.16.ff_context.net.2",
                "transformer_blocks.17.attn.add_k_proj",
                "transformer_blocks.17.attn.add_q_proj",
                "transformer_blocks.17.attn.add_v_proj",
                "transformer_blocks.17.attn.to_add_out",
                "transformer_blocks.17.attn.to_k",
                "transformer_blocks.17.attn.to_out.0",
                "transformer_blocks.17.attn.to_q",
                "transformer_blocks.17.attn.to_v",
                "transformer_blocks.17.ff.net.0.proj",
                "transformer_blocks.17.ff.net.2",
                "transformer_blocks.17.ff_context.net.0.proj",
                "transformer_blocks.17.ff_context.net.2",
                "transformer_blocks.18.attn.add_k_proj",
                "transformer_blocks.18.attn.add_q_proj",
                "transformer_blocks.18.attn.add_v_proj",
                "transformer_blocks.18.attn.to_add_out",
                "transformer_blocks.18.attn.to_k",
                "transformer_blocks.18.attn.to_out.0",
                "transformer_blocks.18.attn.to_q",
                "transformer_blocks.18.attn.to_v",
                "transformer_blocks.18.ff.net.0.proj",
                "transformer_blocks.18.ff.net.2",
                "transformer_blocks.18.ff_context.net.0.proj",
                "transformer_blocks.18.ff_context.net.2",
                "transformer_blocks.2.attn.add_k_proj",
                "transformer_blocks.2.attn.add_q_proj",
                "transformer_blocks.2.attn.add_v_proj",
                "transformer_blocks.2.attn.to_add_out",
                "transformer_blocks.2.attn.to_k",
                "transformer_blocks.2.attn.to_out.0",
                "transformer_blocks.2.attn.to_q",
                "transformer_blocks.2.attn.to_v",
                "transformer_blocks.2.ff.net.0.proj",
                "transformer_blocks.2.ff.net.2",
                "transformer_blocks.2.ff_context.net.0.proj",
                "transformer_blocks.2.ff_context.net.2",
                "transformer_blocks.3.attn.add_k_proj",
                "transformer_blocks.3.attn.add_q_proj",
                "transformer_blocks.3.attn.add_v_proj",
                "transformer_blocks.3.attn.to_add_out",
                "transformer_blocks.3.attn.to_k",
                "transformer_blocks.3.attn.to_out.0",
                "transformer_blocks.3.attn.to_q",
                "transformer_blocks.3.attn.to_v",
                "transformer_blocks.3.ff.net.0.proj",
                "transformer_blocks.3.ff.net.2",
                "transformer_blocks.3.ff_context.net.0.proj",
                "transformer_blocks.3.ff_context.net.2",
                "transformer_blocks.4.attn.add_k_proj",
                "transformer_blocks.4.attn.add_q_proj",
                "transformer_blocks.4.attn.add_v_proj",
                "transformer_blocks.4.attn.to_add_out",
                "transformer_blocks.4.attn.to_k",
                "transformer_blocks.4.attn.to_out.0",
                "transformer_blocks.4.attn.to_q",
                "transformer_blocks.4.attn.to_v",
                "transformer_blocks.4.ff.net.0.proj",
                "transformer_blocks.4.ff.net.2",
                "transformer_blocks.4.ff_context.net.0.proj",
                "transformer_blocks.4.ff_context.net.2",
                "transformer_blocks.5.attn.add_k_proj",
                "transformer_blocks.5.attn.add_q_proj",
                "transformer_blocks.5.attn.add_v_proj",
                "transformer_blocks.5.attn.to_add_out",
                "transformer_blocks.5.attn.to_k",
                "transformer_blocks.5.attn.to_out.0",
                "transformer_blocks.5.attn.to_q",
                "transformer_blocks.5.attn.to_v",
                "transformer_blocks.5.ff.net.0.proj",
                "transformer_blocks.5.ff.net.2",
                "transformer_blocks.5.ff_context.net.0.proj",
                "transformer_blocks.5.ff_context.net.2",
                "transformer_blocks.6.attn.add_k_proj",
                "transformer_blocks.6.attn.add_q_proj",
                "transformer_blocks.6.attn.add_v_proj",
                "transformer_blocks.6.attn.to_add_out",
                "transformer_blocks.6.attn.to_k",
                "transformer_blocks.6.attn.to_out.0",
                "transformer_blocks.6.attn.to_q",
                "transformer_blocks.6.attn.to_v",
                "transformer_blocks.6.ff.net.0.proj",
                "transformer_blocks.6.ff.net.2",
                "transformer_blocks.6.ff_context.net.0.proj",
                "transformer_blocks.6.ff_context.net.2",
                "transformer_blocks.7.attn.add_k_proj",
                "transformer_blocks.7.attn.add_q_proj",
                "transformer_blocks.7.attn.add_v_proj",
                "transformer_blocks.7.attn.to_add_out",
                "transformer_blocks.7.attn.to_k",
                "transformer_blocks.7.attn.to_out.0",
                "transformer_blocks.7.attn.to_q",
                "transformer_blocks.7.attn.to_v",
                "transformer_blocks.7.ff.net.0.proj",
                "transformer_blocks.7.ff.net.2",
                "transformer_blocks.7.ff_context.net.0.proj",
                "transformer_blocks.7.ff_context.net.2",
                "transformer_blocks.8.attn.add_k_proj",
                "transformer_blocks.8.attn.add_q_proj",
                "transformer_blocks.8.attn.add_v_proj",
                "transformer_blocks.8.attn.to_add_out",
                "transformer_blocks.8.attn.to_k",
                "transformer_blocks.8.attn.to_out.0",
                "transformer_blocks.8.attn.to_q",
                "transformer_blocks.8.attn.to_v",
                "transformer_blocks.8.ff.net.0.proj",
                "transformer_blocks.8.ff.net.2",
                "transformer_blocks.8.ff_context.net.0.proj",
                "transformer_blocks.8.ff_context.net.2",
                "transformer_blocks.9.attn.add_k_proj",
                "transformer_blocks.9.attn.add_q_proj",
                "transformer_blocks.9.attn.add_v_proj",
                "transformer_blocks.9.attn.to_add_out",
                "transformer_blocks.9.attn.to_k",
                "transformer_blocks.9.attn.to_out.0",
                "transformer_blocks.9.attn.to_q",
                "transformer_blocks.9.attn.to_v",
                "transformer_blocks.9.ff.net.0.proj",
                "transformer_blocks.9.ff.net.2",
                "transformer_blocks.9.ff_context.net.0.proj",
                "transformer_blocks.9.ff_context.net.2",
            ]

        return target_modules


@torch.no_grad()
def load_lora_weights(dictionary, filename, loraKey="default", use_dora=False):
    additional_keys = set()
    state_dict = safetensors.torch.load_file(filename)
    for prefix, model in dictionary.items():
        lora_layers = {
            (prefix + "." + x): y
            for (x, y) in model.named_modules()
            if isinstance(y, peft.tuners.lora.layer.Linear)
        }
    missing_keys = set(
        [x + ".lora_A.weight" for x in lora_layers.keys()]
        + [x + ".lora_B.weight" for x in lora_layers.keys()]
        + (
            [x + ".lora_magnitude_vector.weight" for x in lora_layers.keys()]
            if use_dora
            else []
        )
    )
    for k, v in state_dict.items():
        if "lora_A" in k:
            kk = k.replace(".lora_A.weight", "")
            if kk in lora_layers:
                lora_layers[kk].lora_A[loraKey].weight.copy_(v)
                missing_keys.remove(k)
            else:
                additional_keys.add(k)
        elif "lora_B" in k:
            kk = k.replace(".lora_B.weight", "")
            if kk in lora_layers:
                lora_layers[kk].lora_B[loraKey].weight.copy_(v)
                missing_keys.remove(k)
            else:
                additional_keys.add(k)
        elif ".alpha" in k or ".lora_alpha" in k:
            kk = k.replace(".lora_alpha", "").replace(".alpha", "")
            if kk in lora_layers:
                lora_layers[kk].lora_alpha[loraKey] = v
        elif ".lora_magnitude_vector" in k:
            kk = k.replace(".lora_magnitude_vector.weight", "")
            if kk in lora_layers:
                lora_layers[kk].lora_magnitude_vector[loraKey].weight.copy_(v)
                missing_keys.remove(k)
            else:
                additional_keys.add(k)
    return (additional_keys, missing_keys)
